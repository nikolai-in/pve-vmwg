# –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∑–∞—â–∏—Ç—ã —Å–µ—Ç–∏

–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã –∑–∞—â–∏—Ç—ã –Ω–∞ Proxmox-—Å–µ—Ä–≤–µ—Ä–µ.

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞

1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–∏—Å—Ç–µ–º—É:

   ```bash
   ansible-playbook -i inventory.yml deploy-vmwg-subnet.yml
   ```

2. –ó–∞–π—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:

   ```bash
   ssh root@your-proxmox-host
   ```

## –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç—ã

### 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
network-failsafe status
```

**–ß—Ç–æ –æ–∂–∏–¥–∞—Ç—å:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–Ω–∏–º–∫–∏ –∏ –Ω–µ–¥–∞–≤–Ω—é—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.

### 2. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
network-failsafe test
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ/—á–∏—Å—Ç–æ)
- –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 15 —Å–µ–∫—É–Ω–¥
- –ñ–¥–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞** - —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. –¢–µ—Å—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º

```bash
network-failsafe test 30
```

**–°–ª—É—á–∞–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** –¢–µ—Å—Ç —Å –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º (30 —Å–µ–∫—É–Ω–¥) –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º.

## –†—É—á–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ö–æ–≥–¥–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ)

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
network-failsafe status

# 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º
network-failsafe arm 60 preserve

# 3. –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å
network-failsafe status

# 4. –î–æ–∂–¥–∞—Ç—å—Å—è —Ç–∞–π–º–∞—É—Ç–∞ (–∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ)
# network-failsafe disarm  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–æ —Ç–∞–π–º–∞—É—Ç–∞

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
network-failsafe status
ip addr show vmwg0  # –î–æ–ª–∂–µ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
systemctl status wg-quick@wg0  # –î–æ–ª–∂–µ–Ω –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å
```

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π 2: –†–µ–∂–∏–º –æ—á–∏—Å—Ç–∫–∏ (–î–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)

```bash
# 1. –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏—Ç—å
ansible-playbook -i inventory.yml cleanup-vmwg-subnet.yml

# 2. SSH –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ Proxmox –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
network-failsafe arm 60 clean

# 3. –í—Ä—É—á–Ω—É—é —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞—Ç—å (–∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–±–æ–π —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)
ip link add dummy0 type dummy
ip addr add 192.168.99.1/24 dev dummy0

# 4. –î–æ–∂–¥–∞—Ç—å—Å—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è (60 —Å–µ–∫—É–Ω–¥)
# –î–æ–ª–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å dummy –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∏—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```

## –ù–∞ —á—Ç–æ –æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ

### ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —É—Å–ø–µ—Ö–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
tail -f /var/log/network-failsafe.log

# –ò—Å–∫–∞—Ç—å —ç—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
# "FAILSAFE TRIGGERED - Network failsafe timeout reached"
# "FAILSAFE COMPLETE - Network restored to [state]"
```

### üîç –ö–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
ip addr show

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ª—É–∂–±—ã
systemctl status wg-quick@wg0
systemctl status dnsmasq@vmwgnat

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
iptables -t nat -L POSTROUTING -n | grep 10.10.0

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é
ip rule show | grep 200
```

## –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤

```bash
# –ê–≤—Ç–æ —Ä–µ–∂–∏–º (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
network-failsafe arm 30 auto

# –†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
network-failsafe arm 30 preserve

# –†–µ–∂–∏–º –æ—á–∏—Å—Ç–∫–∏ (–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)
network-failsafe arm 30 clean
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤

```bash
# –°–æ–∑–¥–∞—Ç—å —Ä—É—á–Ω–æ–π —Å–Ω–∏–º–æ–∫
network-failsafe arm 30  # –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Å–Ω–∏–º–∫–∏

# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤
network-failsafe status

# –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∏–º–∫–∞
network-failsafe restore
# –ó–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ: pre-failsafe –∏–ª–∏ target-state
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep network-failsafe

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π lock —Ñ–∞–π–ª
ls -la /tmp/network-failsafe.lock

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
pkill -f network-failsafe
rm -f /tmp/network-failsafe.lock

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -20 /var/log/network-failsafe.log
```

### –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –ï—Å–ª–∏ —Å–µ—Ç—å –∑–∞–≤–∏—Å–ª–∞
/usr/local/bin/recover-network.sh

# –ò–ª–∏ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
ansible-playbook -i inventory.yml cleanup-vmwg-subnet.yml
```

## –ë—ã—Å—Ç—Ä–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ (5 –º–∏–Ω—É—Ç)

```bash
# 1. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å
network-failsafe status

# 2. –ê–≤—Ç–æ —Ç–µ—Å—Ç (15 —Å–µ–∫—É–Ω–¥)
network-failsafe test

# 3. –†—É—á–Ω–æ–π 30-—Å–µ–∫—É–Ω–¥–Ω—ã–π —Ç–µ—Å—Ç
network-failsafe arm 30

# 4. –ù–∞–±–ª—é–¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –∏ –ª–æ–≥–∏
tail -f /var/log/network-failsafe.log &
sleep 35

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
network-failsafe status
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –í —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

- **–†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å vmwg0 –æ—Å—Ç–∞–µ—Ç—Å—è, —Å–ª—É–∂–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- **–†–µ–∂–∏–º –æ—á–∏—Å—Ç–∫–∏**: –í—Å–µ —É–¥–∞–ª—è–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—Ç –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

### –í —á–∏—Å—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

- **–†–µ–∂–∏–º –æ—á–∏—Å—Ç–∫–∏**: –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —á–∏—Å—Ç–æ–π (–Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- **–†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**: –ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å, –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —á–∏—Å—Ç–æ–π

–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –æ–Ω–∞ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ç–∏ –∏ –∏–º–µ–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.
