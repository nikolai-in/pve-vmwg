#!/bin/bash
# –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ç–µ–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
# –ï–¥–∏–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —Å–µ—Ç–µ–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: network-failsafe {arm|disarm|status|test|restore} [–æ–ø—Ü–∏–∏]

set -euo pipefail

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
CONFIG_DIR="/etc/network-failsafe"
BACKUP_DIR="/var/backups/network-failsafe"
LOCK_FILE="/tmp/network-failsafe.lock"
LOG_FILE="/var/log/network-failsafe.log"
DEFAULT_TIMEOUT=300

# –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
mkdir -p "$CONFIG_DIR" "$BACKUP_DIR"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" | tee -a "$LOG_FILE"
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
show_usage() {
    cat <<'EOF'
–ó–∞—â–∏—Ç–∞ —Å–µ—Ç–∏ - —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: network-failsafe <–∫–æ–º–∞–Ω–¥–∞> [–ø–∞—Ä–∞–º–µ—Ç—Ä—ã]

–ö–æ–º–∞–Ω–¥—ã:
  arm [—Å–µ–∫—É–Ω–¥—ã] [—Ä–µ–∂–∏–º]    –í–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 300—Å, —É–º–Ω—ã–π —Ä–µ–∂–∏–º)
  disarm                   –í—ã–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É
  status                   –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
  test [—Å–µ–∫—É–Ω–¥—ã]           –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15—Å)
  restore                  –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ç—å –≤—Ä—É—á–Ω—É—é
  help                     –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:
  auto                     –£–º–Ω—ã–π —Ä–µ–∂–∏–º - —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á—Ç–æ –¥–µ–ª–∞—Ç—å
  preserve                 –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è
  clean                    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

–ü—Ä–∏–º–µ—Ä—ã:
  network-failsafe arm                    # –ó–∞—â–∏—Ç–∞ –Ω–∞ 5 –º–∏–Ω—É—Ç
  network-failsafe arm 600 preserve       # –ó–∞—â–∏—Ç–∞ –Ω–∞ 10 –º–∏–Ω—É—Ç, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  network-failsafe test                   # –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –Ω–∞ 15 —Å–µ–∫—É–Ω–¥
  network-failsafe status                 # –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å
  network-failsafe disarm                 # –û—Ç–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É

EOF
}

# –°–æ–∑–¥–∞—Ç—å —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏
create_snapshot() {
    local snapshot_name="$1"
    local snapshot_dir="$BACKUP_DIR/$snapshot_name"

    log "–î–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å–µ—Ç–∏: $snapshot_name"
    mkdir -p "$snapshot_dir"

    # –°–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
    cp /etc/network/interfaces "$snapshot_dir/interfaces"
    if [[ -d /etc/network/interfaces.d ]]; then
        cp -r /etc/network/interfaces.d "$snapshot_dir/interfaces.d" 2>/dev/null || true
    fi

    # –ü—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
    iptables-save >"$snapshot_dir/iptables.rules"
    ip6tables-save >"$snapshot_dir/ip6tables.rules"

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
    ip route show >"$snapshot_dir/routes"
    ip rule show >"$snapshot_dir/rules"

    # –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª—É–∂–±
    echo "# –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª—É–∂–± –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞" >"$snapshot_dir/services"
    for service in dnsmasq wg-quick@wg0 dnsmasq@vmwgnat; do
        if systemctl is-enabled "$service" >/dev/null 2>&1; then
            echo "enabled:$service" >>"$snapshot_dir/services"
        fi
        if systemctl is-active "$service" >/dev/null 2>&1; then
            echo "active:$service" >>"$snapshot_dir/services"
        fi
    done

    # –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
    ip addr show >"$snapshot_dir/interfaces.state"
    ip link show >"$snapshot_dir/links.state"

    log "–°–Ω–∏–º–æ–∫ —Å–æ–∑–¥–∞–Ω: $snapshot_name"
}

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Å–Ω–∏–º–∫–∞
restore_snapshot() {
    local snapshot_name="$1"
    local snapshot_dir="$BACKUP_DIR/$snapshot_name"

    if [[ ! -d "$snapshot_dir" ]]; then
        log "–û–®–ò–ë–ö–ê: –°–Ω–∏–º–æ–∫ $snapshot_name –Ω–µ –Ω–∞–π–¥–µ–Ω"
        return 1
    fi

    log "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∏–º–∫–∞: $snapshot_name"

    # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Å–ª—É–∂–±—ã
    for service in wg-quick@wg0 dnsmasq@vmwgnat; do
        systemctl stop "$service" 2>/dev/null || true
    done

    # –£–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ü–µ–ª–µ–≤–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    for iface in vmwg0 dummy0; do
        if ip link show "$iface" >/dev/null 2>&1; then
            log "–£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: $iface"
            ifdown "$iface" 2>/dev/null || true
            ip link delete "$iface" 2>/dev/null || true
        fi
    done

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ç–∏
    if [[ -f "$snapshot_dir/interfaces" ]]; then
        cp "$snapshot_dir/interfaces" /etc/network/interfaces
    fi

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å interfaces.d –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    rm -rf /etc/network/interfaces.d 2>/dev/null || true
    if [[ -d "$snapshot_dir/interfaces.d" ]]; then
        cp -r "$snapshot_dir/interfaces.d" /etc/network/interfaces.d
    fi

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
    if [[ -f "$snapshot_dir/iptables.rules" ]]; then
        iptables-restore <"$snapshot_dir/iptables.rules" 2>/dev/null || true
    fi
    if [[ -f "$snapshot_dir/ip6tables.rules" ]]; then
        ip6tables-restore <"$snapshot_dir/ip6tables.rules" 2>/dev/null || true
    fi

    # –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)
    ip rule show | grep "lookup 200" | while read -r rule; do
        ip rule del "$(echo "$rule" | cut -d: -f2-)" 2>/dev/null || true
    done
    ip route flush table 200 2>/dev/null || true

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ç—å
    systemctl restart networking 2>/dev/null || true

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É–∂–±—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–Ω–∏–º–∫–∞
    if [[ -f "$snapshot_dir/services" ]]; then
        while IFS=: read -r state service; do
            case "$state" in
            enabled)
                systemctl enable "$service" 2>/dev/null || true
                ;;
            active)
                systemctl start "$service" 2>/dev/null || true
                ;;
            esac
        done <"$snapshot_dir/services"
    fi

    log "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: $snapshot_name"
}

# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
detect_state() {
    local deployment_active=false

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
    if [[ -f "/etc/network/interfaces.d/vmwgnat" ]] ||
        ip link show vmwg0 >/dev/null 2>&1 ||
        systemctl is-active wg-quick@wg0 >/dev/null 2>&1; then
        deployment_active=true
    fi

    if $deployment_active; then
        echo "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ"
    else
        echo "—á–∏—Å—Ç–æ"
    fi
}

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
arm_failsafe() {
    local timeout=${1:-$DEFAULT_TIMEOUT}
    local mode=${2:-auto}

    if [[ -f "$LOCK_FILE" ]]; then
        echo "‚ö†Ô∏è  –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'network-failsafe disarm' —Å–Ω–∞—á–∞–ª–∞ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ 'network-failsafe status'"
        return 1
    fi

    # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∂–∏–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –µ—Å–ª–∏ –∞–≤—Ç–æ
    if [[ "$mode" == "auto" ]]; then
        local current_state
        current_state=$(detect_state)
        if [[ "$current_state" == "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ" ]]; then
            mode="preserve"
        else
            mode="clean"
        fi
        log "–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: $mode (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $current_state)"
    fi

    # –°–æ–∑–¥–∞—Ç—å —Å–Ω–∏–º–∫–∏
    create_snapshot "pre-failsafe"
    if [[ "$mode" == "preserve" ]]; then
        create_snapshot "target-state"
    fi

    # –°–æ–∑–¥–∞—Ç—å lock —Ñ–∞–π–ª —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    cat >"$LOCK_FILE" <<EOF
mode=$mode
timeout=$timeout
armed_at=$(date '+%Y-%m-%d %H:%M:%S')
target_snapshot=$([ "$mode" == "preserve" ] && echo "target-state" || echo "pre-failsafe")
EOF

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä
    (
        log "–°–µ—Ç–µ–≤–æ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ - ${timeout}—Å —Ç–∞–π–º–∞—É—Ç (—Ä–µ–∂–∏–º: $mode)"
        sleep "$timeout"

        if [[ -f "$LOCK_FILE" ]]; then
            log "–†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ò–ï –°–†–ê–ë–û–¢–ê–õ–û - –î–æ—Å—Ç–∏–≥–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç —Å–µ—Ç–µ–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è"

            # –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            local target_snapshot
            target_snapshot=$(grep "target_snapshot=" "$LOCK_FILE" | cut -d= -f2)

            # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç—å lock —Ñ–∞–π–ª
            rm -f "$LOCK_FILE"

            # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            restore_snapshot "$target_snapshot"

            log "–†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û - –°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è $target_snapshot"
            echo "–ê–ö–¢–ò–í–ò–†–û–í–ê–ù–û –°–ï–¢–ï–í–û–ï –†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ò–ï - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è $target_snapshot" | wall 2>/dev/null || true
        fi
    ) &

    echo "‚úÖ –ó–∞—â–∏—Ç–∞ —Å–µ—Ç–∏ –≤–∫–ª—é—á–µ–Ω–∞"
    echo "   –í—Ä–µ–º—è: ${timeout} —Å–µ–∫—É–Ω–¥"
    echo "   –†–µ–∂–∏–º: $mode"
    echo "   –î–µ–π—Å—Ç–≤–∏–µ: $([ "$mode" == "preserve" ] && echo "—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å" || echo "–≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –±—ã–ª–æ")"
    echo
    echo "–í—ã–∫–ª—é—á–∏—Ç—å: network-failsafe disarm"
}

# –û—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
disarm_failsafe() {
    if [[ ! -f "$LOCK_FILE" ]]; then
        echo "‚ÑπÔ∏è  –ê–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        return 0
    fi

    rm -f "$LOCK_FILE"
    log "–°–µ—Ç–µ–≤–æ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤—Ä—É—á–Ω—É—é"
    echo "‚úÖ –°–µ—Ç–µ–≤–æ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ"
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
show_status() {
    echo "üîç –°—Ç–∞—Ç—É—Å —Å–µ—Ç–µ–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è"
    echo "================================="

    if [[ -f "$LOCK_FILE" ]]; then
        echo "üî¥ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–û - –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ"
        echo
        echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
        cat "$LOCK_FILE" | sed 's/^/  /'
        echo
        echo "–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è: (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ sleep)"
        if pgrep -f "sleep.*network-failsafe" >/dev/null; then
            echo "  –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω"
        else
            echo "  ‚ö†Ô∏è  –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    else
        echo "üü¢ –û–¢–ö–õ–Æ–ß–ï–ù–û - –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è"
    fi

    echo
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–Ω–∏–º–∫–∏:"
    if [[ -d "$BACKUP_DIR" ]]; then
        local found_snapshots=false
        for snapshot in "$BACKUP_DIR"/*; do
            if [[ -d "$snapshot" ]]; then
                echo "  $(basename "$snapshot")"
                found_snapshots=true
            fi
        done
        if ! $found_snapshots; then
            echo "  (–Ω–µ—Ç)"
        fi
    else
        echo "  (–Ω–µ—Ç)"
    fi

    echo
    echo "–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã: $(detect_state)"

    echo
    echo "–ù–µ–¥–∞–≤–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:"
    if [[ -f "$LOG_FILE" ]]; then
        tail -5 "$LOG_FILE" | sed 's/^/  /'
    else
        echo "  (–Ω–µ—Ç —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤)"
    fi
}

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
test_failsafe() {
    local timeout=${1:-15}

    echo "üß™ –¢–µ—Å—Ç —Å–µ—Ç–µ–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è"
    echo "==============================="
    echo

    local current_state
    current_state=$(detect_state)
    echo "–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $current_state"

    if [[ "$current_state" == "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ" ]]; then
        echo "–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
        local test_mode="preserve"
    else
        echo "–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"
        local test_mode="clean"
    fi

    echo
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å ${timeout}—Å —Ç–µ—Å—Ç–æ–º? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "–¢–µ—Å—Ç –æ—Ç–º–µ–Ω–µ–Ω"
        return 0
    fi

    # –û—á–∏—Å—Ç–∏—Ç—å –ª—é–±–æ–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
    disarm_failsafe >/dev/null 2>&1 || true

    echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞..."
    arm_failsafe "$timeout" "$test_mode"

    echo
    echo "‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞..."
    for i in $(seq "$timeout" -1 1); do
        printf "\r   %2d —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–ª–æ—Å—å..." $i
        sleep 1
    done
    echo

    # –î–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    sleep 3

    echo
    echo "üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:"
    if tail -10 "$LOG_FILE" | grep -q "–†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ò–ï –°–†–ê–ë–û–¢–ê–õ–û"; then
        echo "‚úÖ –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ —É—Å–ø–µ—à–Ω–æ"

        local new_state
        new_state=$(detect_state)
        echo "–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è: $new_state"

        if [[ "$test_mode" == "preserve" && "$new_state" == "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ" ]] ||
            [[ "$test_mode" == "clean" && "$new_state" == "—á–∏—Å—Ç–æ" ]]; then
            echo "‚úÖ –£–°–ü–ï–•: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
        else
            echo "‚ùå –°–ë–û–ô: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è"
        fi
    else
        echo "‚ùå –°–ë–û–ô: –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ"
    fi
}

# –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
manual_restore() {
    echo "üîß –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∏"
    echo "============================="
    echo
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–Ω–∏–º–∫–∏:"
    if [[ -d "$BACKUP_DIR" ]]; then
        local found_any=false
        for snapshot in "$BACKUP_DIR"/*; do
            if [[ -d "$snapshot" ]]; then
                echo "  $(basename "$snapshot")"
                found_any=true
            fi
        done
        if ! $found_any; then
            echo "  (–Ω–µ—Ç)"
        fi
    else
        echo "  (–Ω–µ—Ç)"
    fi
    echo
    read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–Ω–∏–º–∫–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–ª–∏ 'cancel'): " snapshot_name

    if [[ "$snapshot_name" == "cancel" || -z "$snapshot_name" ]]; then
        echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        return 0
    fi

    if [[ ! -d "$BACKUP_DIR/$snapshot_name" ]]; then
        echo "‚ùå –°–Ω–∏–º–æ–∫ '$snapshot_name' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        return 1
    fi

    echo
    echo "‚ö†Ô∏è  –≠—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ç–∏ –¥–æ —Å–Ω–∏–º–∫–∞: $snapshot_name"
    read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        return 0
    fi

    restore_snapshot "$snapshot_name"
    echo "‚úÖ –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä –∫–æ–º–∞–Ω–¥
main() {
    case "${1:-help}" in
    arm)
        arm_failsafe "${2:-}" "${3:-}"
        ;;
    disarm)
        disarm_failsafe
        ;;
    status)
        show_status
        ;;
    test)
        test_failsafe "${2:-}"
        ;;
    restore)
        manual_restore
        ;;
    help | --help | -h)
        show_usage
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: ${1:-}"
        echo
        show_usage
        exit 1
        ;;
    esac
}

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ –≤—Å–µ–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
main "$@"
