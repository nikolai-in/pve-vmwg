#!/bin/bash
# Скрипт для восстановления стандартного Proxmox SDN dnsmasq@dhcpsnat

echo "=== Восстановление стандартного Proxmox SDN ==="

# Проверка наличия конфигурации dhcpsnat
if [ ! -d "/etc/dnsmasq.d/dhcpsnat" ]; then
    echo "❌ Конфигурация dhcpsnat не найдена"
    echo "Возможно, на данном Proxmox нет настроенных SDN сетей"
    exit 1
fi

echo "✅ Конфигурация dhcpsnat найдена"

# Проверка статуса сервиса
if systemctl is-active --quiet dnsmasq@dhcpsnat; then
    echo "✅ dnsmasq@dhcpsnat уже запущен"
else
    echo "⚠️  dnsmasq@dhcpsnat не запущен, запускаем..."
    
    # Перезагрузка systemd
    systemctl daemon-reload
    
    # Включение и запуск сервиса
    systemctl enable dnsmasq@dhcpsnat
    systemctl start dnsmasq@dhcpsnat
    
    # Проверка результата
    sleep 3
    if systemctl is-active --quiet dnsmasq@dhcpsnat; then
        echo "✅ dnsmasq@dhcpsnat успешно запущен"
    else
        echo "❌ Не удалось запустить dnsmasq@dhcpsnat"
        systemctl status dnsmasq@dhcpsnat --no-pager -l
        exit 1
    fi
fi

# Проверка D-Bus сервиса
echo "Проверка D-Bus сервиса..."
sleep 2

if dbus-send --system --dest=org.freedesktop.DBus --print-reply /org/freedesktop/DBus org.freedesktop.DBus.ListNames | grep -q "uk.org.thekelleys.dnsmasq.dhcpsnat"; then
    echo "✅ D-Bus сервис dhcpsnat доступен"
else
    echo "❌ D-Bus сервис dhcpsnat НЕ доступен"
    echo "Попробуем перезапустить dnsmasq@dhcpsnat..."
    
    systemctl restart dnsmasq@dhcpsnat
    sleep 3
    
    if dbus-send --system --dest=org.freedesktop.DBus --print-reply /org/freedesktop/DBus org.freedesktop.DBus.ListNames | grep -q "uk.org.thekelleys.dnsmasq.dhcpsnat"; then
        echo "✅ D-Bus сервис dhcpsnat теперь доступен"
    else
        echo "❌ D-Bus сервис все еще недоступен"
        echo "Показываем логи dnsmasq@dhcpsnat:"
        journalctl -u dnsmasq@dhcpsnat --no-pager -n 10
        exit 1
    fi
fi

echo ""
echo "✅ Стандартный Proxmox SDN восстановлен!"
echo "Теперь можно попробовать запустить LXC контейнер:"
echo "pct start 222"
echo ""
echo "Для диагностики LXC проблем используйте:"
echo "/root/debug-lxc.sh"
