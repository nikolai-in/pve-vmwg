#!/bin/bash
# LXC Container Debug Script
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

echo "=== LXC Container Debug Script ==="
echo "–î–∞—Ç–∞: $(date)"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
check_container() {
    local ctid=$1
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $ctid:"
    
    # –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    if pct status $ctid >/dev/null 2>&1; then
        local status=$(pct status $ctid | awk '{print $2}')
        echo "  –°—Ç–∞—Ç—É—Å: $status"
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ç–∏
        echo "  –°–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
        pct config $ctid | grep "^net" | sed 's/^/    /'
        
        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω
        if [ "$status" != "running" ]; then
            echo "  –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞:"
            journalctl -u pve-container@$ctid --no-pager -n 5 | sed 's/^/    /'
        fi
    else
        echo "  ‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $ctid –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    echo ""
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ D-Bus —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ D-Bus —Å–µ—Ä–≤–∏—Å–æ–≤:"
echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ dnsmasq D-Bus —Å–µ—Ä–≤–∏—Å—ã:"
if command -v dbus-send >/dev/null 2>&1; then
    dbus-send --system --dest=org.freedesktop.DBus --print-reply /org/freedesktop/DBus org.freedesktop.DBus.ListNames 2>/dev/null | grep -E "uk\.org\.thekelleys\.dnsmasq" | sed 's/^/  /' || echo "  –ù–µ—Ç dnsmasq D-Bus —Å–µ—Ä–≤–∏—Å–æ–≤"
else
    echo "  dbus-send –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ dnsmasq —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ dnsmasq —Å–µ—Ä–≤–∏—Å–æ–≤:"
for service in dnsmasq@vmwgnat dnsmasq@dhcpsnat; do
    echo "  $service:"
    if systemctl is-active --quiet $service; then
        echo "    ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω"
        echo "    PID: $(systemctl show $service --property=MainPID --value)"
    else
        echo "    ‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω"
        echo "    –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
        journalctl -u $service --no-pager -n 3 | tail -n 3 | sed 's/^/      /'
    fi
done
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ hook-—Å–∫—Ä–∏–ø—Ç–æ–≤
echo "üîó Hook-—Å–∫—Ä–∏–ø—Ç—ã LXC:"
if [ -d "/usr/share/lxc/hooks" ]; then
    echo "  –ù–∞–π–¥–µ–Ω–Ω—ã–µ hook-—Å–∫—Ä–∏–ø—Ç—ã:"
    ls -la /usr/share/lxc/hooks/ | sed 's/^/    /'
else
    echo "  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è hook-—Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

if [ -d "/etc/pve/lxc" ]; then
    echo "  –ê–∫—Ç–∏–≤–Ω—ã–µ hook-—Å–∫—Ä–∏–ø—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö:"
    grep -r "hookscript" /etc/pve/lxc/ 2>/dev/null | sed 's/^/    /' || echo "    –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö hook-—Å–∫—Ä–∏–ø—Ç–æ–≤"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üè† –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
if command -v pct >/dev/null 2>&1; then
    containers=$(pct list | awk 'NR>1 {print $1}' | head -5)  # –ü–µ—Ä–≤—ã–µ 5 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    if [ -n "$containers" ]; then
        for ctid in $containers; do
            check_container $ctid
        done
    else
        echo "  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
else
    echo "  pct –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–Ω–µ Proxmox —Å–∏—Å—Ç–µ–º–∞?)"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –¥–ª—è LXC
echo "üåâ –°–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è LXC:"
echo "  –î–æ—Å—Ç—É–ø–Ω—ã–µ bridge –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:"
ip link show type bridge | grep -E "^[0-9]+:" | sed 's/^/    /'

echo "  vmwg0 —Å—Ç–∞—Ç—É—Å:"
if ip link show vmwg0 >/dev/null 2>&1; then
    ip addr show vmwg0 | sed 's/^/    /'
else
    echo "    ‚ùå vmwg0 –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Proxmox SDN
echo "üèóÔ∏è  Proxmox SDN:"
if [ -d "/etc/pve/sdn" ]; then
    echo "  SDN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞:"
    find /etc/pve/sdn -name "*.cfg" | sed 's/^/    /'
    
    if [ -f "/etc/pve/sdn/running-config" ]; then
        echo "  –ê–∫—Ç–∏–≤–Ω–∞—è SDN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    else
        echo "  ‚ö†Ô∏è  –ê–∫—Ç–∏–≤–Ω–∞—è SDN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
else
    echo "  SDN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º:"
echo ""
echo "1. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∏–∑-–∑–∞ D-Bus:"
echo "   /root/fix-proxmox-sdn.sh"
echo ""
echo "2. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é:"
echo "   /root/debug-vmwg0.sh"
echo ""
echo "3. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å dnsmasq:"
echo "   /root/debug-dnsmasq.sh"
echo ""
echo "4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:"
echo "   systemctl restart dnsmasq@dhcpsnat"
echo "   systemctl restart dnsmasq@vmwgnat"
echo ""
echo "5. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –æ—Ç–ª–∞–¥–∫–æ–π:"
echo "   pct start <CTID> --debug"
echo ""

echo "=== –ö–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞ ==="
