# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ Proxmox systemd template

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ú—ã –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π systemd template `/etc/systemd/system/dnsmasq@.service`, –∫–æ—Ç–æ—Ä—ã–π:
- ‚ùå –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª –≥–ª–æ–±–∞–ª—å–Ω—ã–π template –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ dnsmasq
- ‚ùå –ú–æ–≥ —Å–ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Proxmox
- ‚ùå –°–æ–∑–¥–∞–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å Proxmox SDN

## üèóÔ∏è –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Proxmox template

**–£–±—Ä–∞–ª–∏:** `/etc/systemd/system/dnsmasq@.service` (–Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π)  
**–ò—Å–ø–æ–ª—å–∑—É–µ–º:** `/lib/systemd/system/dnsmasq@.service` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Proxmox)

### 2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π template —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ

```systemd
ExecStart=/usr/share/dnsmasq/systemd-helper exec "%i"
```

**systemd-helper –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- ‚úÖ –ß–∏—Ç–∞–µ—Ç `/etc/default/dnsmasq.{INSTANCE}`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `$DNSMASQ_OPTS` 
- ‚úÖ –í–∫–ª—é—á–∞–µ—Ç D-Bus –¥–ª—è SDN –∑–æ–Ω
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ D-Bus –¥–ª—è –Ω–∞—à–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### 3. –°–æ–∑–¥–∞–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è vmwgnat

**–§–∞–π–ª:** `/etc/default/dnsmasq.vmwgnat`
```bash
CONFIG_DIR="/etc/dnsmasq.d/vmwgnat,*.conf"
DNSMASQ_USER="dnsmasq"
# –ù–µ—Ç DNSMASQ_OPTS - –∑–Ω–∞—á–∏—Ç –Ω–µ—Ç D-Bus
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### vmwgnat (–Ω–∞—à —Å–µ—Ä–≤–∏—Å):
```
/usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.vmwgnat.pid -u dnsmasq 
  -7 "/etc/dnsmasq.d/vmwgnat,*.conf" --local-service
```
**–ë–µ–∑ D-Bus** - –∫–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å

### PureEvil (Proxmox SDN):
```
/usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.PureEvil.pid -u dnsmasq 
  -7 "/etc/dnsmasq.d/PureEvil,*.conf" --enable-dbus=uk.org.thekelleys.dnsmasq.PureEvil
```
**–° D-Bus** - –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç Proxmox

## üõ°Ô∏è –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ù–µ —Ç—Ä–æ–≥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ systemd template  
‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã Proxmox  
‚úÖ **–û–±–Ω–æ–≤–ª—è–µ–º–æ—Å—Ç—å**: –ù–µ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ú–µ–Ω—å—à–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∫–æ–¥–∞  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –≤—Ä–µ–º–µ–Ω–µ–º —Ä–µ—à–µ–Ω–∏–µ  

## üîß –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ Ansible

### –£–±—Ä–∞–ª–∏:
```yaml
- name: Deploy dnsmasq systemd service template
  ansible.builtin.template:
    src: templates/dnsmasq@.service.j2
    dest: /etc/systemd/system/dnsmasq@.service
```

### –î–æ–±–∞–≤–∏–ª–∏:
```yaml
- name: Create dnsmasq default configuration for vmwgnat
  ansible.builtin.template:
    src: templates/dnsmasq-vmwgnat-default.j2
    dest: /etc/default/dnsmasq.vmwgnat

- name: Remove custom systemd template (restore to Proxmox standard)
  ansible.builtin.file:
    path: /etc/systemd/system/dnsmasq@.service
    state: absent
```

## üéâ –ò—Ç–æ–≥

**–ú—ã –Ω–∞—É—á–∏–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–¥—Ö–æ–¥—É:**
- üîÑ –ù–µ –ø–µ—Ä–µ–∏–∑–æ–±—Ä–µ—Ç–∞—Ç—å –∫–æ–ª–µ—Å–æ
- ü§ù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Å–∏—Å—Ç–µ–º—ã
- üõ°Ô∏è –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- üìö –ò–∑—É—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∫–æ–¥–∞

**–¢–µ–ø–µ—Ä—å –Ω–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Proxmox –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ –ù–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- ‚úÖ –°–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Unix –∏ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º
