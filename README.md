# Proxmox: –ø–æ–¥—Å–µ—Ç—å –í–ú —á–µ—Ä–µ–∑ WireGuard

Ansible-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥—Å–µ—Ç–∏ –í–ú –Ω–∞ Proxmox. –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –í–ú –∏–¥–µ—Ç —á–µ—Ä–µ–∑ WireGuard VPN. –° –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É.

**‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Proxmox SDN** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã Proxmox –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å Software-Defined Networking.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [Proxmox: –ø–æ–¥—Å–µ—Ç—å –í–ú —á–µ—Ä–µ–∑ WireGuard](#proxmox-–ø–æ–¥—Å–µ—Ç—å-–≤–º-—á–µ—Ä–µ–∑-wireguard)
  - [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](#—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)
  - [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
  - [–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è](#—á—Ç–æ-–ø–æ–ª—É—á–∏—Ç—Å—è)
  - [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ç–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–µ—Ç–∏)
    - [–ü–æ—Ç–æ–∫ —Ç—Ä–∞—Ñ–∏–∫–∞](#–ø–æ—Ç–æ–∫-—Ç—Ä–∞—Ñ–∏–∫–∞)
  - [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
  - [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
    - [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
  - [–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Proxmox SDN](#—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å-—Å-proxmox-sdn)
  - [–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ç–∏](#–∑–∞—â–∏—Ç–∞-–æ—Ç-–æ—à–∏–±–æ–∫-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏-—Å–µ—Ç–∏)
    - [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç)
    - [–ö–æ–º–∞–Ω–¥—ã](#–∫–æ–º–∞–Ω–¥—ã)
    - [–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ—Å—å –Ω–µ —Ç–∞–∫](#–µ—Å–ª–∏-—á—Ç–æ-—Ç–æ-–ø–æ—à–ª–æ—Å—å-–Ω–µ-—Ç–∞–∫)
      - [–ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ LXC](#–ø—Ä–æ–±–ª–µ–º–∞-—Å-–∑–∞–ø—É—Å–∫–æ–º-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤-lxc)
      - [–ò–∑ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Äa Proxmox](#–∏–∑-–∫–æ–Ω—Å–æ–ª–∏-—Å–µ—Ä–≤–µ—Äa-proxmox)
  - [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-—Å–∏—Å—Ç–µ–º—ã)
    - [–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞](#–±—ã—Å—Ç—Ä–∞—è-–ø—Ä–æ–≤–µ—Ä–∫–∞)
    - [–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ä—É—á–Ω–æ–µ-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    - [–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏](#–ø—Ä–æ–≤–µ—Ä–∫–∞-—Å–µ—Ç–∏)
  - [–§–∞–π–ª—ã, —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ](#—Ñ–∞–π–ª—ã-—Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ-–Ω–∞-—Å–µ—Ä–≤–µ—Ä–µ)
    - [–°–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#—Å–µ—Ç–µ–≤–∞—è-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
    - [WireGuard VPN](#wireguard-vpn)
    - [–°–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å](#—Å–µ—Ç–µ–≤–æ–π-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
    - [DHCP —Å–µ—Ä–≤–µ—Ä (dnsmasq)](#dhcp-—Å–µ—Ä–≤–µ—Ä-dnsmasq)
    - [–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã](#—Å–∏—Å—Ç–µ–º–Ω—ã–µ-—Å–µ—Ä–≤–∏—Å—ã)
    - [–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã](#–¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)
    - [–ñ—É—Ä–Ω–∞–ª—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–∂—É—Ä–Ω–∞–ª—ã-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
    - [–°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏](#—Å–∫—Ä–∏–ø—Ç—ã-—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è-–∏-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
    - [–ó–∞—á–µ–º —Ç–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã?](#–∑–∞—á–µ–º-—Ç–∞–∫–∏–µ-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Proxmox VE
- Ansible
- SSH –¥–æ—Å—Ç—É–ø –∫ Proxmox —Ö–æ—Å—Ç—É
- –î–∞–Ω–Ω—ã–µ WireGuard —Å–µ—Ä–≤–µ—Ä–∞

## –ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è

- **–ú–æ—Å—Ç vmwg0** (10.10.0.1/24) ‚Äî –∫ –Ω–µ–º—É –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –í–ú
- **DHCP** —á–µ—Ä–µ–∑ dnsmasq —Ä–∞–∑–¥–∞–µ—Ç IP 10.10.0.2-254
- **VPN**: –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –í–ú —á–µ—Ä–µ–∑ WireGuard
- **–ó–∞—â–∏—Ç–∞**: –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ç–∏

```mermaid
graph TB
    subgraph "–•–æ—Å—Ç Proxmox"
        subgraph "–ü–æ–¥—Å–µ—Ç—å –í–ú 10.10.0.0/24"
            VM1["–í–ú 1<br/>10.10.0.2"]
            VM2["–í–ú 2<br/>10.10.0.3"]
            VM3["–í–ú N<br/>10.10.0.x"]
        end

        Bridge["–ú–æ—Å—Ç vmwg0<br/>10.10.0.1/24<br/>DHCP –°–µ—Ä–≤–µ—Ä"]
        WG["WireGuard wg0<br/>VPN –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å"]
        Physical["–§–∏–∑–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å<br/>eth0/ens18"]
        Host["–•–æ—Å—Ç Proxmox<br/>–û–±—ã—á–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫"]

        VM1 --> Bridge
        VM2 --> Bridge
        VM3 --> Bridge

        Bridge -->|NAT –ø—Ä–∞–≤–∏–ª–∞| WG
        WG -->|–¢—Ä–∞—Ñ–∏–∫ –í–ú —á–µ—Ä–µ–∑ VPN| Physical
        Host -->|–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ| Physical
    end

    subgraph "–í–Ω–µ—à–Ω—è—è —Å–µ—Ç—å"
        VPN_Server["WireGuard –°–µ—Ä–≤–µ—Ä<br/>–í–Ω–µ—à–Ω–∏–π VPN –ø—Ä–æ–≤–∞–π–¥–µ—Ä"]
        ISP["–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä<br/>–û–±—ã—á–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫"]
        Web["üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç"]
    end

    Physical -->|–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π VPN —Ç—É–Ω–Ω–µ–ª—å<br/>–¢—Ä–∞—Ñ–∏–∫ –í–ú| VPN_Server
    Physical -->|–û–±—ã—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ<br/>–¢—Ä–∞—Ñ–∏–∫ —Ö–æ—Å—Ç–∞| ISP
    VPN_Server --> Web
    ISP --> Web

    subgraph "–ó–∞—â–∏—Ç–∞ —Å–µ—Ç–∏"
        Failsafe["network-failsafe<br/>‚è∞ –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è<br/>üîí –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"]
    end

    Failsafe -.->|–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∑–∞—â–∏—Ç–∞| Bridge
    Failsafe -.->|–≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ| Physical

    classDef vm fill:#1976d2,stroke:#0d47a1,stroke-width:2px,color:#ffffff
    classDef network fill:#7b1fa2,stroke:#4a148c,stroke-width:2px,color:#ffffff
    classDef vpn fill:#388e3c,stroke:#1b5e20,stroke-width:2px,color:#ffffff
    classDef protection fill:#f57c00,stroke:#e65100,stroke-width:2px,color:#ffffff
    classDef host fill:#d32f2f,stroke:#b71c1c,stroke-width:2px,color:#ffffff

    class VM1,VM2,VM3 vm
    class Bridge,Physical network
    class WG,VPN_Server vpn
    class Failsafe protection
    class Host,ISP host
```

### –ü–æ—Ç–æ–∫ —Ç—Ä–∞—Ñ–∏–∫–∞

1. **–í–ú** –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ –º–æ—Å—Ç `vmwg0`
2. **NAT –ø—Ä–∞–≤–∏–ª–∞** –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç —Ç—Ä–∞—Ñ–∏–∫ –í–ú —Å –ø–æ–¥—Å–µ—Ç–∏ 10.10.0.0/24 –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `wg0`
3. **WireGuard** —à–∏—Ñ—Ä—É–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –í–ú –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
4. **VPN-—Å–µ—Ä–≤–µ—Ä** —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –í–ú –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
5. **–•–æ—Å—Ç Proxmox** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—ã—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–±–µ–∑ VPN)
6. **–ó–∞—â–∏—Ç–∞** —Å–ª–µ–¥–∏—Ç –∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏ —Å–±–æ–µ

**–í–∞–∂–Ω–æ:** –¢–æ–ª—å–∫–æ —Ç—Ä–∞—Ñ–∏–∫ –í–ú –∏–¥–µ—Ç —á–µ—Ä–µ–∑ VPN, —Ç—Ä–∞—Ñ–∏–∫ —Å–∞–º–æ–≥–æ —Ö–æ—Å—Ç–∞ Proxmox –æ—Å—Ç–∞–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
‚îú‚îÄ‚îÄ deploy-vmwg-subnet.yml      # –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–±—É–∫
‚îú‚îÄ‚îÄ cleanup-vmwg-subnet.yml     # —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ
‚îú‚îÄ‚îÄ inventory.yml               # –≤–∞—à –∫–æ–Ω—Ñ–∏–≥ (—Å–æ–∑–¥–∞—Ç—å –∏–∑ .example)
‚îú‚îÄ‚îÄ inventory.example.yml       # –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
‚îú‚îÄ‚îÄ ansible.cfg                 # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Ansible
‚îú‚îÄ‚îÄ verify-setup.sh             # –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ network-failsafe        # —Å–∫—Ä–∏–ø—Ç –∑–∞—â–∏—Ç—ã —Å–µ—Ç–∏
‚îî‚îÄ‚îÄ templates/                  # —à–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥–æ–≤
    ‚îú‚îÄ‚îÄ debug-vmwg0.sh.j2       # –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    ‚îú‚îÄ‚îÄ debug-dnsmasq.sh.j2     # –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ dnsmasq
    ‚îú‚îÄ‚îÄ dnsmasq-default.conf.j2 # –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ dnsmasq
    ‚îú‚îÄ‚îÄ dnsmasq-vmwg0.conf.j2   # DHCP –¥–ª—è vmwg0
    ‚îú‚îÄ‚îÄ dnsmasq@.service.j2     # systemd —Å–µ—Ä–≤–∏—Å
    ‚îú‚îÄ‚îÄ vmwgnat.j2              # —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    ‚îî‚îÄ‚îÄ wg0.conf.j2             # –∫–æ–Ω—Ñ–∏–≥ WireGuard
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞

   ```bash
   cp inventory.example.yml inventory.yml
   ```

2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ [inventory.yml](inventory.yml)

3. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é ansible –≤ [ansible.cfg](ansible.cfg), –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ WSL

4. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å

   ```bash
   ansible-playbook deploy-vmwg-subnet.yml
   ```

5. –í —Å–ª—É—á–∞–µ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

   ```bash
   ansible-playbook cleanup-vmwg-subnet.yml
   ```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Proxmox SDN

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Proxmox Software-Defined Networking (SDN):

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã Proxmox**  
‚úÖ **–ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å SDN –∑–æ–Ω–∞–º–∏**  
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç D-Bus –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è SDN**  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–µ–Ω –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö Proxmox**  

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `/lib/systemd/system/dnsmasq@.service` template
- –°–æ–∑–¥–∞–µ—Ç `/etc/default/dnsmasq.vmwgnat` –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ù–∞—à —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ D-Bus, SDN –∑–æ–Ω—ã - —Å D-Bus
- –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ [PROXMOX-SDN-COMPATIBILITY.md](PROXMOX-SDN-COMPATIBILITY.md)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–í `deploy-vmwg-subnet.yml` –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:

```yaml
vars:
  vm_subnet: "10.10.0.0/24" # –ø–æ–¥—Å–µ—Ç—å –í–ú
  vm_gateway: "10.10.0.1" # —à–ª—é–∑
  vm_dhcp_range_start: "10.10.0.2" # –Ω–∞—á–∞–ª–æ DHCP
  vm_dhcp_range_end: "10.10.0.254" # –∫–æ–Ω–µ—Ü DHCP
  routing_table_id: 200 # ID —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
```

## –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ç–∏

–ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ç–∏:

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. –°—Ç–∞–≤–∏—Ç —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç
3. –ï—Å–ª–∏ –≤—Å–µ –û–ö ‚Äî –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è —Å–∞–º–∞
4. –ï—Å–ª–∏ —Å–ª–æ–º–∞–ª–æ—Å—å ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ

### –ö–æ–º–∞–Ω–¥—ã

```bash
network-failsafe status          # —Å—Ç–∞—Ç—É—Å
network-failsafe test            # —Ç–µ—Å—Ç –Ω–∞ 15 —Å–µ–∫—É–Ω–¥
network-failsafe arm 300         # –≤–∫–ª—é—á–∏—Ç—å –Ω–∞ 5 –º–∏–Ω—É—Ç
network-failsafe disarm          # –≤—ã–∫–ª—é—á–∏—Ç—å
```

### –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ—Å—å –Ω–µ —Ç–∞–∫

```bash
# –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
ansible-playbook cleanup-vmwg-subnet.yml
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ LXC

–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π D-Bus:

```text
The name uk.org.thekelleys.dnsmasq.dhcpsnat was not provided by any .service files
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏–ª–∏ –ø–æ—Ä—è–¥–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–ª–µ–π–±—É–∫ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã):

```bash
ansible-playbook deploy-vmwg-subnet.yml
```

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ `bind-dynamic` (–∂–¥–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
- –î–æ–±–∞–≤–ª–µ–Ω—ã systemd –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- –£–ª—É—á—à–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
- –£–±—Ä–∞–Ω–∞ –Ω–µ–Ω—É–∂–Ω–∞—è D-Bus –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—É–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ñ–∞–π–ª–∞—Ö [DNSMASQ-INTERFACE-FIX.md](DNSMASQ-INTERFACE-FIX.md) –∏ [DBUS-REMOVAL-EXPLANATION.md](DBUS-REMOVAL-EXPLANATION.md).

#### –ò–∑ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Äa Proxmox

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞—â–∏—Ç—ã
ps aux | grep network-failsafe

# –ü–æ—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f network-failsafe
rm -f /tmp/network-failsafe.lock

# –õ–æ–≥–∏
tail -20 /var/log/network-failsafe.log

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∑–∞—â–∏—Ç—ã
network-failsafe restore
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

SSH –Ω–∞ Proxmox –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å:

```bash
# –°—Ç–∞—Ç—É—Å –∑–∞—â–∏—Ç—ã
network-failsafe status

# –ê–≤—Ç–æ—Ç–µ—Å—Ç (15 —Å–µ–∫, –±–µ–∑–æ–ø–∞—Å–Ω–æ)
network-failsafe test

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏
/root/debug-vmwg0.sh
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –í–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É –Ω–∞ 1 –º–∏–Ω—É—Ç—É
network-failsafe arm 60

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
tail -f /var/log/network-failsafe.log

# –î–æ—Å—Ä–æ—á–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
network-failsafe disarm
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏

```bash
# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
ip addr show vmwg0

# –°–µ—Ä–≤–∏—Å—ã
systemctl status wg-quick@wg0
systemctl status dnsmasq@vmwgnat

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Proxmox SDN
systemctl status dnsmasq@dhcpsnat  # –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

# NAT –ø—Ä–∞–≤–∏–ª–∞
iptables -t nat -L POSTROUTING | grep 10.10.0

# –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip rule show | grep 200
```

## –§–∞–π–ª—ã, —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –°–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**`/etc/network/interfaces.d/vmwgnat`** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ—Å—Ç–∞ vmwg0

```bash
# –ú–æ—Å—Ç –¥–ª—è –í–ú —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
auto vmwg0
iface vmwg0 inet static
    address 10.10.0.1/24
    bridge_ports none          # –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–æ—Å—Ç –±–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ä—Ç–æ–≤
    bridge_stp off            # –æ—Ç–∫–ª—é—á–∞–µ–º STP –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    bridge_fd 0               # —É–±–∏—Ä–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É forward delay

    # –ü–æ–ª–∏—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ - —Ç—Ä–∞—Ñ–∏–∫ –í–ú —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    up ip rule add from 10.10.0.0/24 table 200 priority 100
    up ip route add default via 10.8.0.10 dev wg0 table 200  # —á–µ—Ä–µ–∑ VPN

    # NAT –¥–ª—è –ø–æ–¥—Å–µ—Ç–∏ –í–ú —á–µ—Ä–µ–∑ WireGuard
    up iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -o wg0 -j MASQUERADE
    up iptables -A FORWARD -i vmwg0 -o wg0 -j ACCEPT
    up iptables -A FORWARD -i wg0 -o vmwg0 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

**`/etc/network/interfaces`** - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å–µ—Ç–∏ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –±–ª–æ–∫)

```bash
# VM Subnet Bridge with WireGuard VPN routing
auto vmwg0
iface vmwg0 inet static
    address 10.10.0.1/24
    bridge_ports none
    bridge_stp off
    bridge_fd 0
```

### WireGuard VPN

**`/etc/wireguard/wg0.conf`** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VPN —Ç—É–Ω–Ω–µ–ª—è

```ini
[Interface]
PrivateKey = –≤–∞—à_–ø—Ä–∏–≤–∞—Ç–Ω—ã–π_–∫–ª—é—á
Address = 10.8.0.10/24, fdcc:ad94:bacf:61a4::cafe:a/112  # IP –≤ VPN —Å–µ—Ç–∏
Table = 32768                  # –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Ç–∞–±–ª–∏—Ü–µ 200 –¥–ª—è —Ç—Ä–∞—Ñ–∏–∫–∞ –í–ú
PostUp = ip route add default dev wg0 scope global table 200
PostDown = ip route del default dev wg0 table 200 2>/dev/null || true

[Peer]
PublicKey = –ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á_—Å–µ—Ä–≤–µ—Ä–∞
PresharedKey = –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_–∫–ª—é—á
Endpoint = –≤–∞—à.—Å–µ—Ä–≤–µ—Ä.com:51820
AllowedIPs = 0.0.0.0/0, ::/0   # –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ VPN
PersistentKeepalive = 10       # –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```

### –°–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**`/etc/network/interfaces.d/vmwgnat`** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ—Å—Ç–∞ vmwg0

```bash
auto vmwg0
iface vmwg0
address 10.10.0.1/24          # IP —à–ª—é–∑–∞ –¥–ª—è –í–ú
# NAT –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –í–ú –≤ VPN
post-up iptables -t nat -A POSTROUTING -s '10.10.0.0/24' -o wg0 -j MASQUERADE
post-down iptables -t nat -D POSTROUTING -s '10.10.0.0/24' -o wg0 -j MASQUERADE
# –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è Proxmox firewall –∑–æ–Ω
post-up iptables -t raw -I PREROUTING -i fwbr+ -j CT --zone 1
post-down iptables -t raw -D PREROUTING -i fwbr+ -j CT --zone 1
# Policy-based routing: —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç/–∫ –í–ú –∏–¥–µ—Ç —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É 200
post-up ip rule add from 10.10.0.0/24 table 200 priority 100
post-down ip rule del from 10.10.0.0/24 table 200 priority 100 2>/dev/null || true
post-up ip rule add to 10.10.0.0/24 table 200 priority 101
post-down ip rule del to 10.10.0.0/24 table 200 priority 101 2>/dev/null || true
# –õ–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ 200
post-up ip route add 10.10.0.0/24 dev vmwg0 table 200 2>/dev/null || true
post-down ip route del 10.10.0.0/24 dev vmwg0 table 200 2>/dev/null || true
bridge_ports none             # –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–æ—Å—Ç –±–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ä—Ç–æ–≤
bridge_stp off               # –æ—Ç–∫–ª—é—á–∞–µ–º Spanning Tree Protocol
bridge_fd 0                  # –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
ip-forward on                # –≤–∫–ª—é—á–∞–µ–º IP —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥
```

### DHCP —Å–µ—Ä–≤–µ—Ä (dnsmasq)

**`/etc/dnsmasq.d/vmwgnat/00-default.conf`** - –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
# –¢–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞–µ–º —Å vmwg0 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º (–∏–∑–±–µ–≥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å Proxmox SDN)
interface=vmwg0             # —Ç–æ–ª—å–∫–æ –Ω–∞ vmwg0
except-interface=lo         # –Ω–µ —Å–ª—É—à–∞–µ–º –Ω–∞ loopback
bind-dynamic                # –∂–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –µ–≥–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
enable-ra                   # Router Advertisement –¥–ª—è IPv6
quiet-ra                    # —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º RA
no-hosts                    # –Ω–µ —á–∏—Ç–∞–µ–º /etc/hosts
dhcp-leasefile=/var/lib/misc/dnsmasq.vmwgnat.leases
dhcp-hostsfile=/etc/dnsmasq.d/vmwgnat/ethers  # —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ MAC->IP

# –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π MTU –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å VPN
dhcp-option=26,1380         # MTU 1380 (1500 - 20 IP - 8 UDP - 32 WireGuard - 60 –∑–∞–ø–∞—Å)
ra-param=*,mtu:1380,0       # —Ç–æ—Ç –∂–µ MTU –¥–ª—è IPv6

# WPAD –æ–ø—Ü–∏—è –¥–ª—è Windows
dhcp-option=252,"\n"        # –ø—É—Å—Ç–∞—è WPAD —Å—Ç—Ä–æ–∫–∞

# Microsoft –æ–ø—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è DHCP –∞—Ä–µ–Ω–¥—ã
dhcp-option=vendor:MSFT,2,1i

# –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫ —á–µ—Ä–µ–∑ WPAD
dhcp-name-match=set:wpad-ignore,wpad
dhcp-ignore-names=tag:wpad-ignore

# DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
dhcp-option=6,10.10.0.1     # DNS —Å–µ—Ä–≤–µ—Ä = gateway (—Å–∞–º dnsmasq)
server=1.1.1.1              # –∞–ø—Å—Ç—Ä–∏–º DNS —Å–µ—Ä–≤–µ—Ä—ã
server=8.8.8.8
server=2606:4700:4700::1111

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
log-queries                 # –ª–æ–≥–∏—Ä—É–µ–º DNS –∑–∞–ø—Ä–æ—Å—ã
log-dhcp                    # –ª–æ–≥–∏—Ä—É–µ–º DHCP —Å–æ–±—ã—Ç–∏—è
log-facility=/var/log/dnsmasq-vmwg.log

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
dhcp-lease-max=150          # –º–∞–∫—Å–∏–º—É–º 150 –∞—Ä–µ–Ω–¥
cache-size=1000             # –∫–µ—à –Ω–∞ 1000 –∑–∞–ø–∏—Å–µ–π
```

**`/etc/dnsmasq.d/vmwgnat/10-vmwg0.conf`** - DHCP –¥–ª—è –í–ú

```bash
# DHCP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ vmwg0
dhcp-option=tag:dhcpsnat-10-10-0-0-24,option:router,10.10.0.1  # —à–ª—é–∑
dhcp-range=set:dhcpsnat-10-10-0-0-24,10.10.0.2,10.10.0.254,255.255.255.0,12h
interface=vmwg0             # —Ç–æ–ª—å–∫–æ –Ω–∞ vmwg0
```

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

**`/etc/systemd/system/dnsmasq@.service`** - —à–∞–±–ª–æ–Ω —Å–µ—Ä–≤–∏—Å–∞ dnsmasq

```ini
[Unit]
Description=dnsmasq - A lightweight DHCP and caching DNS server (%i)
After=network.target        # –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ —Å–µ—Ç–∏
Wants=nss-lookup.target     # —Ö–æ—Ç–∏–º NSS lookup
Before=nss-lookup.target    # –Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º—Å—è –¥–æ –Ω–µ–≥–æ

[Service]
Type=forking               # –ø—Ä–æ—Ü–µ—Å—Å —Ñ–æ—Ä–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω
PIDFile=/run/dnsmasq-%i.pid
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
ExecStartPre=/usr/sbin/dnsmasq --test --conf-dir=/etc/dnsmasq.d/%i,*.conf
# –ó–∞–ø—É—Å–∫–∞–µ–º —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏–∑ /etc/dnsmasq.d/%i/
ExecStart=/usr/sbin/dnsmasq --conf-dir=/etc/dnsmasq.d/%i,*.conf --pid-file=/run/dnsmasq-%i.pid
ExecReload=/bin/kill -HUP $MAINPID  # –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ SIGHUP
Restart=on-failure         # –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ–µ
RestartSec=5              # —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥

[Install]
WantedBy=multi-user.target  # –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
```

**`/etc/systemd/system/wg-quick@wg0.service.d/override.conf`** - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ WireGuard

```ini
[Unit]
After=network-online.target
Wants=network-online.target
# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ vmwg0
After=network.target
Requires=network.target
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

**`/root/debug-vmwg0.sh`** - —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–µ—Ç–∏

```bash
#!/bin/bash
# –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ VPN –ø–æ–¥—Å–µ—Ç–∏
echo "=== WireGuard Status ==="
wg show                      # —Å—Ç–∞—Ç—É—Å WireGuard —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

echo "=== Interface Status ==="
ip addr show vmwg0          # –ø—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞ –º–æ—Å—Ç–∞
ip addr show wg0            # –ø—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞ VPN

echo "=== Routing Tables ==="
ip route show table main | head -5    # –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (—Ç—Ä–∞—Ñ–∏–∫ —Ö–æ—Å—Ç–∞)
ip route show table 200               # —Ç–∞–±–ª–∏—Ü–∞ 200 (—Ç—Ä–∞—Ñ–∏–∫ –í–ú)

echo "=== Policy Routing Rules ==="
ip rule show | grep -E "(200|10\.10\.0)" # –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

echo "=== NAT Rules ==="
iptables -t nat -L POSTROUTING -n | grep "10\.10\.0"  # NAT –ø—Ä–∞–≤–∏–ª–∞

echo "=== Service Status ==="
systemctl is-active wg-quick@wg0      # —Å—Ç–∞—Ç—É—Å WireGuard
systemctl is-active dnsmasq@vmwgnat   # —Å—Ç–∞—Ç—É—Å DHCP

echo "=== DHCP Leases ==="
cat /var/lib/misc/dnsmasq.vmwgnat.leases 2>/dev/null || echo "–ù–µ—Ç –∞—Ä–µ–Ω–¥"

echo "=== DNS Resolution Test ==="
nslookup google.com 10.10.0.1         # —Ç–µ—Å—Ç DNS —á–µ—Ä–µ–∑ —à–ª—é–∑ –í–ú
```

### –ñ—É—Ä–Ω–∞–ª—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**`/var/log/network-failsafe.log`** - –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã –∑–∞—â–∏—Ç—ã

```bash
tail -f /var/log/network-failsafe.log  # –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∑–∞—â–∏—Ç—ã
```

**`/var/log/dnsmasq-vmwg.log`** - –ª–æ–≥–∏ DHCP –∏ DNS

```bash
tail -f /var/log/dnsmasq-vmwg.log      # –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ DHCP/DNS
```

### –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**`/usr/local/bin/network-failsafe`** - —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã —Å–µ—Ç–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ —Å–±–æ–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –¢–∞–π–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ `/var/backups/network-failsafe/`

**`/root/debug-vmwg0.sh`** - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

```bash
#!/bin/bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
echo "=== –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ vmwg0 –ø–æ–¥—Å–µ—Ç–∏ ==="
echo "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:"
ip addr show vmwg0
echo "–°–µ—Ä–≤–∏—Å—ã:"
systemctl status wg-quick@wg0 dnsmasq@vmwgnat
echo "NAT –ø—Ä–∞–≤–∏–ª–∞:"
iptables -t nat -L POSTROUTING -n | grep 10.10.0
echo "–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:"
ip rule show | grep 200
ip route show table 200
```

### –ó–∞—á–µ–º —Ç–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã?

**Bridge –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

- `bridge_stp off` - –æ—Ç–∫–ª—é—á–∞–µ—Ç Spanning Tree Protocol –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- `bridge_fd 0` - —É–±–∏—Ä–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ (15 —Å–µ–∫ ‚Üí 0 —Å–µ–∫)
- `bridge_ports none` - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–æ—Å—Ç –±–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ä—Ç–æ–≤

**WireGuard –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `Table = off` - –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã, —É–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä—É—á–Ω—É—é
- `PersistentKeepalive = 25` - –∫–∞–∂–¥—ã–µ 25 —Å–µ–∫ ping –¥–ª—è –ø—Ä–æ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ NAT
- `AllowedIPs = 0.0.0.0/0` - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ VPN

**–ü–æ–ª–∏—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:**

- `table 200` - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è –í–ú
- `priority 100` - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∞–≤–∏–ª–∞
- –¢—Ä–∞—Ñ–∏–∫ —Ö–æ—Å—Ç–∞ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (—Ç–∞–±–ª–∏—Ü–∞ 254)

**DHCP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

- `dhcp-authoritative` - –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã, –Ω–µ –∂–¥–µ–º –¥—Ä—É–≥–∏—Ö DHCP —Å–µ—Ä–≤–µ—Ä–æ–≤
- `port=0` - –æ—Ç–∫–ª—é—á–∞–µ–º DNS –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å Proxmox
- `bind-interfaces` - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Å–ª—É—à–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
