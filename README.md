# Proxmox: –ø–æ–¥—Å–µ—Ç—å –í–ú —á–µ—Ä–µ–∑ WireGuard

Ansible-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥—Å–µ—Ç–∏ –í–ú –Ω–∞ Proxmox. –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –í–ú –∏–¥–µ—Ç —á–µ—Ä–µ–∑ WireGuard VPN. –° –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [Proxmox: –ø–æ–¥—Å–µ—Ç—å –í–ú —á–µ—Ä–µ–∑ WireGuard](#proxmox-–ø–æ–¥—Å–µ—Ç—å-–≤–º-—á–µ—Ä–µ–∑-wireguard)
  - [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](#—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)
  - [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
  - [–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è](#—á—Ç–æ-–ø–æ–ª—É—á–∏—Ç—Å—è)
  - [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ç–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–µ—Ç–∏)
    - [–ü–æ—Ç–æ–∫ —Ç—Ä–∞—Ñ–∏–∫–∞](#–ø–æ—Ç–æ–∫-—Ç—Ä–∞—Ñ–∏–∫–∞)
  - [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
  - [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
    - [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
  - [–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ç–∏](#–∑–∞—â–∏—Ç–∞-–æ—Ç-–æ—à–∏–±–æ–∫-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏-—Å–µ—Ç–∏)
    - [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç)
    - [–ö–æ–º–∞–Ω–¥—ã](#–∫–æ–º–∞–Ω–¥—ã)
    - [–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ—Å—å –Ω–µ —Ç–∞–∫](#–µ—Å–ª–∏-—á—Ç–æ-—Ç–æ-–ø–æ—à–ª–æ—Å—å-–Ω–µ-—Ç–∞–∫)
      - [–ò–∑ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Äa Proxmox](#–∏–∑-–∫–æ–Ω—Å–æ–ª–∏-—Å–µ—Ä–≤–µ—Äa-proxmox)
  - [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-—Å–∏—Å—Ç–µ–º—ã)
    - [–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞](#–±—ã—Å—Ç—Ä–∞—è-–ø—Ä–æ–≤–µ—Ä–∫–∞)
    - [–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ä—É—á–Ω–æ–µ-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    - [–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏](#–ø—Ä–æ–≤–µ—Ä–∫–∞-—Å–µ—Ç–∏)

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Proxmox VE
- Ansible
- SSH –¥–æ—Å—Ç—É–ø –∫ Proxmox —Ö–æ—Å—Ç—É
- –î–∞–Ω–Ω—ã–µ WireGuard —Å–µ—Ä–≤–µ—Ä–∞

## –ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è

- **–ú–æ—Å—Ç vmwg0** (10.10.0.1/24) ‚Äî –∫ –Ω–µ–º—É –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –í–ú
- **DHCP** —á–µ—Ä–µ–∑ dnsmasq —Ä–∞–∑–¥–∞–µ—Ç IP 10.10.0.2-254
- **VPN**: –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –í–ú —á–µ—Ä–µ–∑ WireGuard
- **–ó–∞—â–∏—Ç–∞**: –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ç–∏

```mermaid
graph TB
    subgraph "Proxmox Host"
        subgraph "VM Subnet 10.10.0.0/24"
            VM1["VM 1<br/>10.10.0.2"]
            VM2["VM 2<br/>10.10.0.3"]
            VM3["VM N<br/>10.10.0.x"]
        end

        Bridge["vmwg0 Bridge<br/>10.10.0.1/24<br/>DHCP Server"]
        WG["WireGuard wg0<br/>VPN Interface"]
        Physical["Physical Interface<br/>eth0/ens18"]

        VM1 --> Bridge
        VM2 --> Bridge
        VM3 --> Bridge

        Bridge -->|NAT Rules| WG
        WG --> Physical
    end

    subgraph "External Network"
        VPN_Server["WireGuard Server<br/>External VPN Provider"]
        Web["üåê Internet"]
    end

    Physical -->|Encrypted VPN Tunnel| VPN_Server
    VPN_Server --> Web

    subgraph "Network Protection"
        Failsafe["network-failsafe<br/>‚è∞ Auto-restore timer<br/>üîí Configuration backup"]
    end

    Failsafe -.->|Monitors & Protects| Bridge
    Failsafe -.->|Emergency Restore| Physical

    classDef vm fill:#1976d2,stroke:#0d47a1,stroke-width:2px,color:#ffffff
    classDef network fill:#7b1fa2,stroke:#4a148c,stroke-width:2px,color:#ffffff
    classDef vpn fill:#388e3c,stroke:#1b5e20,stroke-width:2px,color:#ffffff
    classDef protection fill:#f57c00,stroke:#e65100,stroke-width:2px,color:#ffffff

    class VM1,VM2,VM3 vm
    class Bridge,Physical network
    class WG,VPN_Server vpn
    class Failsafe protection
```

### –ü–æ—Ç–æ–∫ —Ç—Ä–∞—Ñ–∏–∫–∞

1. **–í–ú** –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ –º–æ—Å—Ç `vmwg0`
2. **NAT** –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ —Å –ø–æ–¥—Å–µ—Ç–∏ 10.10.0.0/24 –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `wg0`
3. **WireGuard** —à–∏—Ñ—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
4. **VPN-—Å–µ—Ä–≤–µ—Ä** —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
5. **–ó–∞—â–∏—Ç–∞** —Å–ª–µ–¥–∏—Ç –∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏ —Å–±–æ–µ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
‚îú‚îÄ‚îÄ deploy-vmwg-subnet.yml      # –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–±—É–∫
‚îú‚îÄ‚îÄ cleanup-vmwg-subnet.yml     # —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ
‚îú‚îÄ‚îÄ inventory.yml               # –≤–∞—à –∫–æ–Ω—Ñ–∏–≥ (—Å–æ–∑–¥–∞—Ç—å –∏–∑ .example)
‚îú‚îÄ‚îÄ inventory.example.yml       # –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
‚îú‚îÄ‚îÄ ansible.cfg                 # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Ansible
‚îú‚îÄ‚îÄ verify-setup.sh             # –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ network-failsafe        # —Å–∫—Ä–∏–ø—Ç –∑–∞—â–∏—Ç—ã —Å–µ—Ç–∏
‚îî‚îÄ‚îÄ templates/                  # —à–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥–æ–≤
    ‚îú‚îÄ‚îÄ debug-vmwg0.sh.j2       # –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    ‚îú‚îÄ‚îÄ dnsmasq-default.conf.j2 # –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ dnsmasq
    ‚îú‚îÄ‚îÄ dnsmasq-vmwg0.conf.j2   # DHCP –¥–ª—è vmwg0
    ‚îú‚îÄ‚îÄ dnsmasq@.service.j2     # systemd —Å–µ—Ä–≤–∏—Å
    ‚îú‚îÄ‚îÄ vmwgnat.j2              # —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    ‚îî‚îÄ‚îÄ wg0.conf.j2             # –∫–æ–Ω—Ñ–∏–≥ WireGuard
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞

   ```bash
   cp inventory.example.yml inventory.yml
   ```

2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ [inventory.yml](inventory.yml)

3. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é ansible –≤ [ansible.cfg](ansible.cfg), –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ WSL

4. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å

   ```bash
   ansible-playbook deploy-vmwg-subnet.yml
   ```

5. –í —Å–ª—É—á–∞–µ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

   ```bash
   ansible-playbook cleanup-vmwg-subnet.yml
   ```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–í `deploy-vmwg-subnet.yml` –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:

```yaml
vars:
  vm_subnet: "10.10.0.0/24" # –ø–æ–¥—Å–µ—Ç—å –í–ú
  vm_gateway: "10.10.0.1" # —à–ª—é–∑
  vm_dhcp_range_start: "10.10.0.2" # –Ω–∞—á–∞–ª–æ DHCP
  vm_dhcp_range_end: "10.10.0.254" # –∫–æ–Ω–µ—Ü DHCP
  routing_table_id: 200 # ID —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
```

## –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ç–∏

–ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ç–∏:

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. –°—Ç–∞–≤–∏—Ç —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç
3. –ï—Å–ª–∏ –≤—Å–µ –û–ö ‚Äî –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è —Å–∞–º–∞
4. –ï—Å–ª–∏ —Å–ª–æ–º–∞–ª–æ—Å—å ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ

### –ö–æ–º–∞–Ω–¥—ã

```bash
network-failsafe status          # —Å—Ç–∞—Ç—É—Å
network-failsafe test            # —Ç–µ—Å—Ç –Ω–∞ 15 —Å–µ–∫—É–Ω–¥
network-failsafe arm 300         # –≤–∫–ª—é—á–∏—Ç—å –Ω–∞ 5 –º–∏–Ω—É—Ç
network-failsafe disarm          # –≤—ã–∫–ª—é—á–∏—Ç—å
```

### –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ—Å—å –Ω–µ —Ç–∞–∫

```bash
# –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
ansible-playbook cleanup-vmwg-subnet.yml
```

#### –ò–∑ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Äa Proxmox

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞—â–∏—Ç—ã
ps aux | grep network-failsafe

# –ü–æ—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f network-failsafe
rm -f /tmp/network-failsafe.lock

# –õ–æ–≥–∏
tail -20 /var/log/network-failsafe.log

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∑–∞—â–∏—Ç—ã
network-failsafe restore
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

SSH –Ω–∞ Proxmox –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å:

```bash
# –°—Ç–∞—Ç—É—Å –∑–∞—â–∏—Ç—ã
network-failsafe status

# –ê–≤—Ç–æ—Ç–µ—Å—Ç (15 —Å–µ–∫, –±–µ–∑–æ–ø–∞—Å–Ω–æ)
network-failsafe test

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏
/root/debug-vmwg0.sh
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –í–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É –Ω–∞ 1 –º–∏–Ω—É—Ç—É
network-failsafe arm 60

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
tail -f /var/log/network-failsafe.log

# –î–æ—Å—Ä–æ—á–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
network-failsafe disarm
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏

```bash
# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
ip addr show vmwg0

# –°–µ—Ä–≤–∏—Å—ã
systemctl status wg-quick@wg0
systemctl status dnsmasq@vmwgnat

# NAT –ø—Ä–∞–≤–∏–ª–∞
iptables -t nat -L POSTROUTING | grep 10.10.0

# –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip rule show | grep 200
```
