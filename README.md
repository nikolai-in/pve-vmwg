# Proxmox: подсеть ВМ через WireGuard

Ansible-скрипты для настройки изолированной подсети ВМ (10.10.0.0/24) на Proxmox. Трафик всех ВМ идет через WireGuard VPN. Есть защита от потери доступа к серверу.

## Быстрый старт

```bash
# Проверяем что все готово
./verify-setup.sh

# Настраиваем сеть (с защитой от блокировки)
ansible-playbook -i inventory.yml deploy-vmwg-subnet.yml

# Убираем все настройки
ansible-playbook -i inventory.yml cleanup-vmwg-subnet.yml
```

## Что получится

- **Мост**: `vmwg0` (10.10.0.1/24) — к нему подключаются ВМ
- **DHCP**: раздает IP 10.10.0.2-254 через dnsmasq
- **VPN**: весь трафик ВМ через WireGuard
- **Защита**: автоматически откатывается, если что-то сломается

## Защита от блокировки

Чтобы не потерять доступ к серверу, скрипт автоматически откатывает изменения если что-то пойдет не так:

### Команды

```bash
network-failsafe status          # Что сейчас происходит
network-failsafe test            # Тест на 15 секунд
network-failsafe arm             # Включить на 5 минут
network-failsafe disarm          # Выключить
```

### Как работает

1. **Сохраняет** текущие настройки сети
2. **Ставит таймер** на 5 минут
3. **Если все ОК** — отключается сама
4. **Если сломалось** — возвращает настройки обратно

### Режимы

- **auto** — умный режим, сам решает что делать
- **preserve** — сохранить текущие настройки, если что-то пойдет не так
- **clean** — вернуться к исходному состоянию

## Структура репозитория

```text
├── deploy-vmwg-subnet.yml      # Основной playbook развертывания с резервированием
├── cleanup-vmwg-subnet.yml     # Playbook полной очистки
├── inventory.yml               # Конфигурация инвентаря Ansible
├── ansible.cfg                 # Конфигурация Ansible
├── verify-setup.sh             # Проверка настройки и подключения
├── src/
│   ├── network-failsafe        # Основной скрипт защиты сети
│   ├── recover-network.sh      # Аварийное восстановление
│   ├── dnsmasq@.service       # Сервис DHCP
│   ├── dnsmasq.d/             # Настройки DHCP
│   ├── network/               # Сетевые интерфейсы
│   └── wireguard/             # Настройки VPN
└── templates/                 # Шаблоны конфигураций
```

## Пошаговая инструкция

### 1. Подготовка

Укажите в `inventory.yml` данные вашего Proxmox-сервера и WireGuard:

```yaml
proxmox_hosts:
  hosts:
    your-proxmox-host:
      ansible_host: your.proxmox.ip
      wireguard_private_key: "your-private-key"
      wireguard_peer_public_key: "server-public-key"
      # ... остальные настройки WireGuard
```

### 2. Развертывание

Развертывание автоматически активирует 5-минутное резервирование, которое восстановит вашу сеть в случае проблем:

```bash
# Развернуть полный сетевой стек
ansible-playbook -i inventory.yml deploy-vmwg-subnet.yml
```

Система резервирования будет:

- Делать снимок текущего состояния сети
- Развертывать новую конфигурацию
- Автоматически восстанавливать исходное состояние при сбое развертывания
- Отключаться при успешном развертывании

### 3. Тестирование и проверка

После развертывания:

```bash
# SSH на ваш хост Proxmox и запустите диагностику
ssh root@your-proxmox-host
/root/debug-vmwg0.sh
```

### 4. Создание ВМ

В веб-интерфейсе Proxmox:

1. Создайте ВМ и назначьте их мосту `vmwg0`
2. ВМ автоматически получат DHCP адреса из диапазона 10.10.0.2-254
3. Весь трафик ВМ будет маршрутизироваться через ваш WireGuard VPN

## Расширенная настройка

### Сетевые переменные

Эти переменные в `deploy-vmwg-subnet.yml` управляют настройкой сети:

```yaml
vars:
  vm_subnet: "10.10.0.0/24" # Диапазон подсети ВМ
  vm_gateway: "10.10.0.1" # IP шлюза для ВМ
  vm_dhcp_range_start: "10.10.0.2" # Начало диапазона DHCP
  vm_dhcp_range_end: "10.10.0.254" # Конец диапазона DHCP
  routing_table_id: 200 # ID таблицы маршрутизации Linux
```

### Ручное управление резервированием

Вы также можете управлять резервированием вручную на хосте Proxmox:

```bash
# Проверить статус резервирования
network-failsafe status

# Активировать резервирование с пользовательским таймаутом (10 минут)
network-failsafe arm 600

# Протестировать систему резервирования (15-секундный тест)
network-failsafe test

# Отключить активное резервирование
network-failsafe disarm

# Ручное восстановление из снимка
network-failsafe restore
```

## Экстренное восстановление

Если что-то пошло не так и вы потеряли сетевой доступ:

### Из консоли/IPMI

```bash
# Быстрое восстановление сетевого интерфейса
/usr/local/bin/recover-network.sh

# Или ручное восстановление через резервирование
network-failsafe restore
```

### Полное восстановление системы

```bash
# Проверить что произошло
network-failsafe status

# Удалить зависшие процессы
pkill -f "network-failsafe"
rm -f /tmp/network-failsafe.lock

# Запустить экстренную очистку
ansible-playbook -i inventory.yml cleanup-vmwg-subnet.yml
```

## Требования

- Хост Proxmox VE
- Ansible с коллекцией community.general
- Конфигурация WireGuard в templates/wg0.conf.j2
- SSH доступ к хосту Proxmox

## Функции безопасности

- **Автоматическое резервирование**: Защита таймаутом 5 минут во время развертывания
- **Снимки сети**: Полное резервное копирование состояния перед изменениями
- **Управление службами**: Правильный запуск/остановка сетевых служб
- **Поддержка отката**: Может восстановить любое предыдущее состояние
- **Аварийные скрипты**: Инструменты ручного восстановления

## Тестирование

```bash
# Протестировать систему резервирования
network-failsafe test

# Тест с пользовательским таймаутом
network-failsafe test 30

# Проверить статус развертывания
network-failsafe status
```

Система резервирования гарантирует, что вы не будете заблокированы во время изменений конфигурации сети.
