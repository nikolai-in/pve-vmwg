# Подсеть ВМ Proxmox с маршрутизацией через WireGuard VPN

Эта автоматизация Ansible настраивает подсеть ВМ (10.10.0.0/24) на Proxmox с маршрутизацией через WireGuard VPN, включая надежную систему сетевого резервирования, которая защищает от блокировки доступа во время развертывания.

## Быстрый старт

```bash
# Проверить настройку и подключение
./verify-setup.sh

# Развернуть сетевую конфигурацию с автоматическим резервированием
ansible-playbook -i inventory.yml deploy-vmwg-subnet.yml

# Очистка (удаление всей конфигурации)
ansible-playbook -i inventory.yml cleanup-vmwg-subnet.yml
```

## Что создается

- **Мост ВМ**: `vmwg0` (10.10.0.1/24)
- **DHCP сервер**: dnsmasq обслуживает 10.10.0.2-254
- **WireGuard VPN**: Маршрутизирует трафик ВМ через VPN
- **Сетевое резервирование**: Автоматический откат при сбое развертывания

## Система сетевого резервирования

Развертывание включает автоматическое резервирование, которое защищает от блокировки сетевого доступа:

### Основные команды

```bash
network-failsafe status          # Проверить текущий статус
network-failsafe test            # Быстрый 15-секундный тест
network-failsafe arm             # Ручное резервирование (5мин таймаут)
network-failsafe disarm          # Отключить активное резервирование
```

### Как это работает

1. **Перед изменениями**: Создает снимок текущего состояния сети
2. **Во время развертывания**: Активируется с 5-минутным таймаутом
3. **При успехе**: Автоматически отключается
4. **При сбое**: Восстанавливает исходную конфигурацию сети

### Режимы

- **auto** (по умолчанию): Определяет текущее состояние и действует соответственно
- **preserve**: Сохраняет текущее развертывание при срабатывании
- **clean**: Восстанавливает состояние до развертывания при срабатывании

## Структура репозитория

```text
├── deploy-vmwg-subnet.yml      # Основной playbook развертывания с резервированием
├── cleanup-vmwg-subnet.yml     # Playbook полной очистки
├── inventory.yml               # Конфигурация инвентаря Ansible
├── ansible.cfg                 # Конфигурация Ansible
├── verify-setup.sh             # Проверка настройки и подключения
├── src/
│   ├── network-failsafe        # Унифицированный скрипт управления резервированием
│   ├── recover-network.sh      # Экстренное восстановление сети
│   ├── dnsmasq@.service       # Шаблон службы dnsmasq
│   ├── dnsmasq.d/             # Конфигурация DHCP dnsmasq
│   ├── network/               # Конфигурации сетевых интерфейсов
│   └── wireguard/             # Конфигурация WireGuard VPN
└── templates/                 # Шаблоны Jinja2 для динамических конфигураций
```

## Как использовать

### 1. Настройте окружение

Отредактируйте `inventory.yml` с деталями вашего хоста Proxmox и настройками WireGuard:

```yaml
proxmox_hosts:
  hosts:
    your-proxmox-host:
      ansible_host: your.proxmox.ip
      wireguard_private_key: "your-private-key"
      wireguard_peer_public_key: "server-public-key"
      # ... другие настройки WireGuard
```

### 2. Развертывание с автоматическим резервированием

Развертывание автоматически активирует 5-минутное резервирование, которое восстановит вашу сеть в случае проблем:

```bash
# Развернуть полный сетевой стек
ansible-playbook -i inventory.yml deploy-vmwg-subnet.yml
```

Система резервирования будет:

- Делать снимок текущего состояния сети
- Развертывать новую конфигурацию
- Автоматически восстанавливать исходное состояние при сбое развертывания
- Отключаться при успешном развертывании

### 3. Тестирование и проверка

После развертывания:

```bash
# SSH на ваш хост Proxmox и запустите диагностику
ssh root@your-proxmox-host
/root/debug-vmwg0.sh
```

### 4. Создание ВМ

В веб-интерфейсе Proxmox:

1. Создайте ВМ и назначьте их мосту `vmwg0`
2. ВМ автоматически получат DHCP адреса из диапазона 10.10.0.2-254
3. Весь трафик ВМ будет маршрутизироваться через ваш WireGuard VPN

## Расширенная настройка

### Сетевые переменные

Эти переменные в `deploy-vmwg-subnet.yml` управляют настройкой сети:

```yaml
vars:
  vm_subnet: "10.10.0.0/24" # Диапазон подсети ВМ
  vm_gateway: "10.10.0.1" # IP шлюза для ВМ
  vm_dhcp_range_start: "10.10.0.2" # Начало диапазона DHCP
  vm_dhcp_range_end: "10.10.0.254" # Конец диапазона DHCP
  routing_table_id: 200 # ID таблицы маршрутизации Linux
```

### Ручное управление резервированием

Вы также можете управлять резервированием вручную на хосте Proxmox:

```bash
# Проверить статус резервирования
network-failsafe status

# Активировать резервирование с пользовательским таймаутом (10 минут)
network-failsafe arm 600

# Протестировать систему резервирования (15-секундный тест)
network-failsafe test

# Отключить активное резервирование
network-failsafe disarm

# Ручное восстановление из снимка
network-failsafe restore
```

## Экстренное восстановление

Если что-то пошло не так и вы потеряли сетевой доступ:

### Из консоли/IPMI

```bash
# Быстрое восстановление сетевого интерфейса
/usr/local/bin/recover-network.sh

# Или ручное восстановление через резервирование
network-failsafe restore
```

### Полное восстановление системы

```bash
# Проверить что произошло
network-failsafe status

# Удалить зависшие процессы
pkill -f "network-failsafe"
rm -f /tmp/network-failsafe.lock

# Запустить экстренную очистку
ansible-playbook -i inventory.yml cleanup-vmwg-subnet.yml
```

## Требования

- Хост Proxmox VE
- Ansible с коллекцией community.general
- Конфигурация WireGuard в templates/wg0.conf.j2
- SSH доступ к хосту Proxmox

## Функции безопасности

- **Автоматическое резервирование**: Защита таймаутом 5 минут во время развертывания
- **Снимки сети**: Полное резервное копирование состояния перед изменениями
- **Управление службами**: Правильный запуск/остановка сетевых служб
- **Поддержка отката**: Может восстановить любое предыдущее состояние
- **Аварийные скрипты**: Инструменты ручного восстановления

## Тестирование

```bash
# Протестировать систему резервирования
network-failsafe test

# Тест с пользовательским таймаутом
network-failsafe test 30

# Проверить статус развертывания
network-failsafe status
```

Система резервирования гарантирует, что вы не будете заблокированы во время изменений конфигурации сети.
