# –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ D-Bus –ø—Ä–æ–±–ª–µ–º—ã

## üöÄ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞—á–∞–ª–∞, D-Bus –ø–æ—Ç–æ–º

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```
dnsmasq: DBus error: Connection ":1.39" is not allowed to own the service 
"uk.org.thekelleys.dnsmasq.vmwgnat" due to security policies
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ü–æ—ç—Ç–∞–ø–Ω—ã–π –∑–∞–ø—É—Å–∫

#### 1Ô∏è‚É£ **–≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**
- dnsmasq –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ë–ï–ó D-Bus –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (DHCP, DNS, VPN routing)
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

#### 2Ô∏è‚É£ **–≠—Ç–∞–ø 2: –í–∫–ª—é—á–µ–Ω–∏–µ D-Bus (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
```bash
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
ssh root@pve-host
/root/enable-dnsmasq-dbus.sh
```

### üîß –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

1. **D-Bus –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω:**
   ```bash
   # enable-dbus=uk.org.thekelleys.dnsmasq.vmwgnat
   ```

2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω D-Bus XML —Ñ–∞–π–ª:**
   - –£–±—Ä–∞–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–µ—Ä–µ–¥ XML –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–µ–π
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π XML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

3. **–î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è:**
   - `/root/enable-dnsmasq-dbus.sh` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ D-Bus

4. **–£–ª—É—á—à–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
   - `/root/debug-dnsmasq.sh` - –ø—Ä–æ–≤–µ—Ä–∫–∞ XML –∏ D-Bus

### üìã –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

```bash
# 1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–∞–∑–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
ansible-playbook deploy-vmwg-subnet.yml

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
ssh root@pve-host
systemctl status dnsmasq@vmwgnat
/root/debug-dnsmasq.sh

# 3. –í–∫–ª—é—á–∏—Ç—å D-Bus (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
/root/enable-dnsmasq-dbus.sh
```

### üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** D-Bus –Ω–µ –ª–æ–º–∞–µ—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
3. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
4. **–ì–∏–±–∫–æ—Å—Ç—å:** D-Bus –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ
5. **–û—Ç–∫–∞—Ç:** –ï—Å–ª–∏ D-Bus –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Å–Ω–æ–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—á–µ–π

### üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–ë–µ–∑ D-Bus (–±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å):**
```bash
systemctl status dnsmasq@vmwgnat     # –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å active
cat /var/lib/misc/dnsmasq.vmwgnat.leases  # DHCP –∞—Ä–µ–Ω–¥—ã
```

**–° D-Bus (–ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```bash
dbus-send --system --dest=org.freedesktop.DBus --print-reply \
  /org/freedesktop/DBus org.freedesktop.DBus.ListNames | grep vmwgnat
```

### üí° –í–∞–∂–Ω–æ

–î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤ D-Bus –ù–ï –Ω—É–∂–µ–Ω - —ç—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è Proxmox. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (DHCP, DNS, VPN routing) —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –Ω–µ–≥–æ.
